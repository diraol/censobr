---
title: "Introduction to censobr"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
urlcolor: blue
vignette: >
  %\VignetteIndexEntry{Introduction to censobr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = identical(tolower(Sys.getenv("NOT_CRAN")), "true"),
  out.width = "100%"
)
```

**censobr** is an R package to download data from Brazil's Population Census. At the moment, it only includes microdata from the 2010 census, but the package is being expanded to include more years and data sets.

The package currently includes 3 main functions to download Census microdata:

1. `read_population()`
2. `read_households()`
3. `read_deaths()`

The syntax of all **censobr** functions operate on the same logic so it becomes intuitive to download any data set using a single line of code. Like this:

```{r, eval = FALSE}
dfh <- read_households(
          year,          # year of reference
          columns,       # whether to return only selected columns
          as_data_frame, # whether to return an Arrow table or a data.frame
          showProgress,  # whether to show a download progress bar
          cache          # whether to cache data for faster access later
         )

```

## Data too big for memory

Microdata of Brazilian census are often be too big to load in users' RAM memory. To avoid this problem, **censobr** will by default return an [Arrow table](https://arrow.apache.org/docs/r/articles/arrow.html#tabular-data-in-arrow), which can be analyzed like a regular `data.frame` using the `dplyr` package without loading the full data to memory.

Let's see how it works in a couple examples:


## Basic usage

**censobr** is no on CRAN yet. For now, you can install the dev version from Github.

```R
utils::remove.packages('censobr')
devtools::install_github("ipeaGIT/censobr")
```

Now we can load the libraries we'll be using in this vignette.

```{r, eval=TRUE}
library(censobr)
library(arrow)
library(dplyr)
library(geobr)
library(ggplot2)
```

#### Using Population data:

In this example we'll be calculating the propotion of people with higher education in different racial groups in the state of São Paulo. First, we need to use the `read_population()` function to download the of population.

```{r, eval = TRUE, echo = FALSE}
gc(T)
```

```{r, eval = TRUE, warning = FALSE}
pop <- read_population(year = 2010,
                       showProgress = FALSE)

gc()
```

Now, we use the `dplyr` syntax to (a) filter observations for the state of São Paulo, (b) group obervations by racial group, (c) summarise the data calculating the proportion of individuals with higher education.

```{r, eval = TRUE, warning = FALSE}
df <- pop |>
      filter(V0001 == 35) |>                                              # (a)
      group_by(V0606) |>                                                  # (b)
      summarise(higher_edu = sum(V0010[which(V6400==4)]) / sum(V0010)) |> # (c)
      collect()

head(df)
```
Now we only need to add labels to our query and plot the results.

```{r, eval = TRUE}
df <- df |>
      mutate(cor = case_when(V0606 == 1 ~ 'Branca',
                             V0606 == 2 ~ 'Preta',
                             V0606 == 3 ~ 'Amarela',
                             V0606 == 4 ~ 'Parda',
                             V0606 == 5 ~ 'Indígena'
                             ))

ggplot() +
  geom_col(data = na.omit(df), aes(x=cor, y=higher_edu), fill = '#5c997e') +
  scale_y_continuous(name = 'Proportion with higher education',
                     labels = scales::percent) +
  theme_classic()
  
```

#### Using household data:

In this example, we going to map how much people spend with rent across different municipalities in the state of São Paulo . First, we can easily download the households data set with `read_households()`.

```{r, eval = TRUE}
# download household data
hs <- read_households(year = 2010, 
                      showProgress = FALSE)

```

Now we're going to (a) group observations by state, (b) calculate the average rent, and (c) collect the results.

```{r, eval = TRUE, warning = FALSE}
rent <- hs |> 
        group_by(V0001) |>                                                 # (a)
        summarize(avgrent=weighted.mean(x=V2011, w=V0010, na.rm=TRUE)) |>  # (b)
        collect()                                                          # (c)
```

We can use the `geobr` package to download the geometries of Brazilian states.

```{r, eval = TRUE, warning = FALSE}
uf <- geobr::read_state(year = 2010, 
                        showProgress = FALSE)
head(uf)
```

Now we only need to merge the spatial data with our rent estimates and map the results.

```{r, eval = TRUE, warning = FALSE}
rent_sf <- left_join(uf, rent, by = c('code_state' = 'V0001'))

ggplot() +
  geom_sf(data = rent_sf, aes(fill = avgrent), color=NA) +
  scale_fill_distiller(palette = "Oranges", direction = 1, 
                       name='Avgerage\nRent in R$') +
  theme_void()

```
